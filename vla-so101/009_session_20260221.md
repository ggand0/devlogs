# Session Log — 2026-02-21

## Inference Recording Reliability

### ffmpeg shutdown deadlock

The inference script hung after recording completed. Root cause: `ffmpeg_proc.stderr.read()` blocks until EOF on the pipe, which only comes when ffmpeg exits. But ffmpeg was still shutting down (writing mp4 trailer, closing PipeWire audio), so the read blocked indefinitely. Even after `terminate()` (SIGTERM), reading stderr before the process fully exits can deadlock.

First attempted fix: `communicate()` after `stdin.close()`. Failed because `communicate()` eagerly evaluates `stdin.flush()` even on a closed file descriptor — `ValueError: flush of closed file`.

Second attempted fix: read stderr first, then `wait()`. Still hung — ffmpeg writes a lot to stderr (encoding stats), and if it hasn't exited yet, `read()` blocks waiting for EOF.

Final fix: dropped stderr capture entirely (`stderr=subprocess.DEVNULL`) and used `terminate()` → `wait(timeout=5)` → `kill()` as fallback. No pipes to deadlock on. SIGKILL is unconditional — the kernel terminates the process immediately.

Trade-off: if SIGKILL is needed, the mp4 trailer won't be written and the video may be unplayable. But the script will always exit.

### Robot disconnect during recording

Servo communication dropped mid-episode (`ConnectionError: no status packet`). The `finally` block's `reset_to_home()` also failed because the connection was already dead, which meant ffmpeg cleanup never ran and the video was lost.

Fix: wrapped `reset_to_home()` in `try/except` so video is always saved even if the robot disconnects.

Committed as `358e3bc`.

## Training v2 Wrist-Only Model

### Dataset

`gtgando/so101_pick_place_10cm_v2` — 81 episodes, 24,252 frames, wrist cam only (RealSense D405 @ 640×480).

Overhead cam excluded via `--exclude-cameras overhead` flag added to `train.py`. The flag strips camera features from dataset metadata before the policy sees them, so the dataset files stay intact for future two-camera training.

### Implementation

Added `--exclude-cameras` CLI arg to `scripts/train.py` that monkey-patches `make_dataset()` to remove specified camera features from `dataset.meta.features` and `dataset.meta.stats`. Parsed before lerobot's own arg parser runs.

Created `scripts/train_smolvla_v2_wrist.sh` — same hyperparams as v1 (batch_size=64, 20k steps, cosine decay from 1e-4, save every 5k).

### Results

- Duration: 9h 58m
- Final loss: 0.006 (same as v1 two-camera)
- Step time: ~1.79s (v1 was 1.73s)
- Update time identical at 1.19s — single camera doesn't change forward/backward cost since SmolVLA processes through a shared vision encoder

### Eval

High variance across runs (20-80%). Failure mode: grasps air, missing the cube entirely.

| Run | Flags | Success Rate |
|---|---|---|
| 1 | `--no-overhead` | 20% (1/5) |
| 2 | `--no-overhead --direct-reset` | 80% (4/5) |
| 3 | `--no-overhead --direct-reset` | 20% (1/5) |

### Root cause analysis

During v2 data collection, used a "tilt trick" — nudge cube with the static gripper finger to get a good rotation angle before grasping. Applied inconsistently (even to poses that didn't need it), which confused the policy about when to nudge vs go straight for the grasp.

### Lesson: grasp strategy

Always use **wrist roll alignment**, never nudge. The parallel gripper can grasp the cube at any rotation as long as the fingers align with opposite faces. One consistent strategy: lower arm above cube → rotate wrist roll to match cube angle → descend → grasp. This eliminates the conditional nudge-or-not decision and gives the policy a single clean strategy for every cube pose.

## Inference Script Updates

### `--no-overhead` flag

Added to `infer.py` to skip overhead camera entirely. `make_follower()` now takes `no_overhead` param, conditionally excludes overhead from camera config. FrameRecorder handles wrist-only mode (just pipes the single 640×480 frame). ffmpeg command simplified — no PiP filter, no audio (C920 mic is on the overhead cam).

### Default checkpoint

Updated from v1 to v2 wrist: `outputs/train/smolvla_so101_10cm_v2_wrist/checkpoints/last/pretrained_model`

## Hardware Issues

### Overhead cam (Logitech C920) died

LED won't turn on at all, not detected on any USB port. Died after 3-4 days of use. Likely not a quality issue — possible USB power brownout from sharing bus with RealSense D405 and servo controllers. Replaced with another C920.

### USB topology

Checked with `lsusb -t`. RealSense D405 was on Bus 001 at **480Mbps (USB 2.0)** — wrong port. Moved to Bus 002 (10Gbps USB 3.0 controller), now runs at **5000Mbps**.

MSI MEG X570 ACE rear I/O:
- Left side near PS/2: 2x USB 2.0 + 2x USB 3.0 Gen 1 (from X570 chipset)
- Center-right (red ports): 3x USB 3.2 Gen 2 Type-A + 1x USB-C (from CPU, 10Gbps)

The servo arms (QinHeng Serial) are USB 2.0 devices running at 12Mbps Full Speed — they'll run the same regardless of port. The RealSense benefits from USB 3.0 bandwidth.

### Camera device path instability

After moving the RealSense to USB 3.0, it registered as `/dev/video0-5` (6 device nodes for depth + color + metadata streams), pushing the C920 to `/dev/video6-7`. Previously the C920 was `/dev/video2`.

Fix: switched all configs and `infer.py` to use stable symlink paths from `/dev/v4l/by-id/`:
```
/dev/v4l/by-id/usb-046d_HD_Pro_Webcam_C920-video-index0
```
This symlink is stable regardless of plug order or device enumeration. The RealSense wrist cam is accessed via pyrealsense2 SDK (serial number), so it's not affected.

Updated: `infer.py` OVERHEAD_CAM constant + all 5 recording configs.

## Teleoperation Lag

### Problem

Teleoperation feels laggy during recording — follower arm falls behind leader, then catches up in a burst causing jerky movements. Much less noticeable in `camera_preview.py --teleop`.

### Root cause

Lerobot's `record_loop` couples camera capture, dataset writing, and teleop in a single synchronous loop. Each 30fps iteration:

1. `robot.get_observation()` — sync_read all 6 motors + read all cameras (RealSense blocking read ~15-30ms)
2. `build_dataset_frame()` — format conversion
3. `teleop.get_action()` — read leader motor positions
4. `robot.send_action()` — write goal positions to follower
5. `dataset.add_frame()` — parquet + video encoding

Camera reads and dataset I/O block the teleop action forwarding. During that dead time, leader movements queue up.

In `camera_preview.py --teleop`: just `cap.read()` → `get_action()` → `send_action()`. Much tighter loop.

### Not a language/CPU issue

Rewriting in Rust wouldn't help — the bottleneck is blocking I/O (USB frame reads, serial round-trips), not CPU.

### Potential fix

Background camera thread that reads frames continuously, teleop loop just grabs latest cached frame. Same pattern as `FrameRecorder` in `infer.py`. Estimated half a day of work. Not implemented yet.

### Workaround

Move slowly during recording. The lag is small enough that deliberate movements aren't affected.

## Recording v3 Dataset

### Config

`configs/record_10cm_v3.yaml` — 80 episodes, wrist cam only (no overhead cam in config to avoid wasting disk on black frames). `gtgando/so101_pick_place_10cm_v3`.

### Recording script fix

`record.py` hardcoded overhead cam in `make_follower()`. Made it conditional: only adds overhead camera config when `overhead_cam` key exists in the YAML config.

Also fixed eager evaluation bug in `_make_wrist_cam()`: `cfg.get("wrist_cam_width", cfg["cam_width"])` evaluates `cfg["cam_width"]` before `get` checks the first key, so it throws `KeyError` even when `wrist_cam_width` exists. Changed to `cfg.get("wrist_cam_width", cfg.get("cam_width", 640))`.

### Strategy

Clean grasps with wrist roll alignment only, no nudge trick. Approach from above as default but don't force identical trajectories — some variation in approach angle helps generalization.

## Lerobot PR

### PR #1: fix/placo-ee-improvements → so101

https://github.com/ggand0/lerobot/pull/1

"Consolidate reusable improvements from hil-serl for VLA training"

Consolidates ~45 reusable improvements from `feat/hil-serl` (92 commits) onto `so101`, using placo/URDF for FK/IK instead of MuJoCo. All 92 commits analyzed individually: ~45 REUSABLE, ~47 HIL-SERL-ONLY.

Key changes:
- 8 cherry-picked commits (camera auto-detection, image writer fixes, buffer fixes, protobuf, policy factory)
- State caching bug fix in SO101FollowerEndEffector (always read real motor positions)
- IK reset via placo in ResetWrapper (4-step sequence)
- Camera watchdog with force reconnect
- Robust sync_read/write, atexit torque cleanup, gripper [-1,1], normalize_images, degree clamping helpers

Full writeup: `hil-serl-so101/devlogs/087_placo_ee_consolidation.md`

### Pending after merge

1. Commit ROCm→CUDA pyproject.toml change directly on `so101` (local setup, not part of the PR)
2. New branch off `so101` for ACT image resize logic (`resize_imgs` config field + `_resize_with_pad()` in modeling_act.py) and tqdm progress bar in training loop — currently stashed on `fix/placo-ee-improvements`

## Stashed Changes (lerobot)

On `fix/placo-ee-improvements`, stashed:
- `pyproject.toml`: ROCm → CUDA (pytorch index + triton dep)
- `configuration_act.py`: `resize_imgs: tuple[int, int] | None = None` field
- `modeling_act.py`: `_resize_with_pad()` function, applied before backbone in forward pass
- `train.py`: tqdm progress bar wrapping training loop

## Files Modified This Session

### vla-so101 repo
- `scripts/infer.py` — ffmpeg shutdown fix, robot disconnect handling, `--no-overhead` flag, default checkpoint update, stable camera path
- `scripts/train.py` — `--exclude-cameras` flag
- `scripts/train_smolvla_v2_wrist.sh` — new training script
- `scripts/record.py` — optional overhead cam, `_make_wrist_cam` fallback fix
- `configs/record_10cm_v3.yaml` — new v3 config (wrist only, 80 eps)
- `configs/record_10cm_v2_extra.yaml` — updated to 10 episodes
- `configs/*.yaml` — all updated to stable `/dev/v4l/by-id/` camera paths
- `devlog/training_results_10cm_v2_wrist.md` — v2 training results + eval
- `devlog/teleop_lag.md` — teleoperation lag analysis
- `devlog/inference_recording.md` — updated with bug fixes section

### lerobot repo
- PR #1 created (draft): `fix/placo-ee-improvements` → `so101`
- `so101` branch pushed to origin
