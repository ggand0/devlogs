# Bevy 0.14.2 Update and Explosion System Fixes

**Date:** November 12, 2025  
**Session Duration:** ~4 hours  
**Context:** Returning to project after 5 months, updated Rust toolchain  
**Branch:** `feat/objective`

---

## Initial State

User returned to project after 5 months and encountered:
- ‚úÖ Bevy version: Still 0.14 (now resolved to 0.14.2)
- ‚úÖ Rust version: Updated to 1.90.0
- ‚ùå Segmentation fault on startup
- ‚ùå Explosion animations not working (showing full sprite sheet grid)
- ‚ùå Random crashes during tower destruction

---

## Issues Resolved

### 1. Segmentation Fault on Startup

**Symptom:**
```
INFO bevy_mass_render::explosion_shader: üé® New 5x5 flipbook explosion assets loaded!
Segmentation fault (core dumped)
```

**Root Cause:** AMD GPU (Radeon RX 7900 XTX) driver issues with Vulkan backend on Linux.

**Solution:** AMD GPU Vulkan workaround command:
```bash
VK_LOADER_DEBUG=error VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/radeon_icd.x86_64.json cargo run --release
```

**Status:** ‚úÖ Documented in README.md

---

### 2. Bevy 0.14.2 API Compatibility

**Issue:** Custom material `specialize()` method had incorrect signature after Bevy patch update.

**Error:**
```
error[E0053]: method `specialize` has an incompatible type for trait
expected signature: ... &MeshVertexBufferLayoutRef ...
found signature: ... &MeshVertexBufferLayout ...
```

**Fix:** Updated import and signature:
```rust
// Before
use bevy::render::mesh::MeshVertexBufferLayout;

impl Material for ExplosionMaterial {
    fn specialize(
        _layout: &MeshVertexBufferLayout,  // ‚ùå Wrong type
        ...
    ) { ... }
}

// After
use bevy::render::mesh::MeshVertexBufferLayoutRef;

impl Material for ExplosionMaterial {
    fn specialize(
        _layout: &MeshVertexBufferLayoutRef,  // ‚úÖ Correct type
        ...
    ) { ... }
}
```

**Files Changed:** `src/explosion_shader.rs`

**Status:** ‚úÖ Fixed

---

### 3. Explosion Animation Not Working

**Symptom:** Explosions showed entire 5√ó5 sprite sheet grid on a quad, no frame-by-frame animation.

**Root Cause:** `StandardMaterial` **cannot animate UV coordinates**. The system was spawning explosions with:
- `spawn_animated_sprite_explosion()` ‚Üí StandardMaterial-based
- `animate_sprite_explosions()` ‚Üí Only updated alpha/emissive, NOT frame UVs
- Result: Entire texture visible at once, no animation

**Solution:** Switch all explosions to custom shader approach:

```rust
// Tower destruction system - BEFORE
spawn_animated_sprite_explosion(
    &mut commands,
    &mut meshes,
    &mut materials,  // StandardMaterial
    &assets,
    position, radius, intensity, duration
);

// Tower destruction system - AFTER
spawn_custom_shader_explosion(
    &mut commands,
    &mut meshes,
    &mut explosion_materials,  // ExplosionMaterial (custom shader)
    &assets,
    position, radius, intensity, duration
);
```

**How Custom Shader Works:**

1. **Rust side** (`animate_custom_shader_explosions`):
   - Updates `current_frame` counter each tick
   - Calculates frame position: `frame_x = frame % 5`, `frame_y = frame / 5`
   - Updates material uniforms with frame data

2. **Shader side** (`explosion.wgsl`):
   ```wgsl
   let frame_size = 1.0 / 5.0;  // 0.2 for 5√ó5 grid
   let frame_offset = vec2<f32>(frame_x * frame_size, frame_y * frame_size);
   let frame_uv = in.uv * frame_size + frame_offset;
   let sprite_sample = textureSample(sprite_texture, sprite_sampler, frame_uv);
   ```

**Systems Updated:**
- `tower_destruction_system` ‚Üí Added `explosion_materials` parameter, uses custom shader
- `pending_explosion_system` ‚Üí Added `explosion_materials` parameter, uses custom shader

**Debug Enhancement:**
Added frame update logging for first 5 frames:
```rust
if old_frame < 5 {
    info!("üéûÔ∏è Explosion frame update: {} ‚Üí {}", old_frame, sprite_explosion.current_frame);
}
```

**Files Changed:**
- `src/objective.rs` - Updated both explosion systems
- `src/explosion_shader.rs` - Added debug logging

**Status:** ‚úÖ Fixed - Explosions now animate correctly at ~12.5 FPS through 25 frames

---

### 4. Entity Despawn Panic (Race Condition)

**Symptom:** Random crashes during tower destruction:
```
thread 'main' panicked at bevy_ecs/src/system/commands/mod.rs:1256:13:
error[B0003]: Could not insert a bundle (of type PendingExplosion) 
for entity Entity { index: 790, generation: 1 } 
because it doesn't exist in this World.
```

**Root Cause:** Race condition in massive battles (10,000 units):

1. Tower destroyed ‚Üí system queries 736 units within explosion radius
2. Stores entity IDs in a `Vec`
3. **Meanwhile:** Combat systems kill units every frame
4. System tries to add `PendingExplosion` to stored entity IDs
5. Some entities despawned between step 2 and step 4
6. `commands.entity(id).insert(...)` **panics** if entity doesn't exist at flush time

**Previous Attempt (Insufficient):**
```rust
// This only checks at command creation time, not flush time
if let Some(mut entity_commands) = commands.get_entity(unit_entity) {
    entity_commands.insert(PendingExplosion { ... });  // ‚ùå Still panics later
}
```

**Correct Solution:** Use `try_insert()` instead:
```rust
if let Some(mut entity_commands) = commands.get_entity(unit_entity) {
    entity_commands.try_insert(PendingExplosion { ... });  // ‚úÖ Graceful failure
}
```

**Difference:**
- `insert()`: Panics if entity doesn't exist when commands are flushed (B0003 error)
- `try_insert()`: Silently succeeds or fails - returns `Ok(())` or `Err(...)`, no panic

**Applied to:**
- `tower_destruction_system`:
  - Unit cascade explosions (line ~462)
  - Tower entity itself (line ~487)
- `debug_explosion_hotkey_system` (E key):
  - Unit explosions (line ~678)
  - Tower entity (line ~691)

**Files Changed:** `src/objective.rs` (4 locations)

**Status:** ‚úÖ Fixed - No more panics even with 2000+ unit cascade

---

## Documentation Updates

### Created Comprehensive Documentation

1. **`docs/PROJECT_OVERVIEW.md`** (388 lines)
   - Complete game architecture
   - All systems and their responsibilities
   - Configuration constants reference
   - Controls and debug keys
   - Build instructions with AMD GPU workaround
   - Code conventions for future contributors
   - Tips for AI agents

2. **`docs/EXPLOSION_SYSTEM.md`** (809 lines)
   - Explosion system evolution (v1-v4)
   - Complete technical implementation
   - Custom shader deep-dive
   - Component architecture
   - Animation system details
   - **Troubleshooting guide** (updated with today's fixes)
   - Performance analysis
   - API reference with code examples

3. **Updated `README.md`**
   - Added Git LFS as prerequisite
   - Installation instructions for Git LFS
   - `git lfs pull` step in clone instructions
   - AMD GPU Vulkan workaround
   - Updated features list (objectives, explosions, formations)
   - Organized controls by category
   - Links to technical documentation

### Git LFS Configuration

**Asset Sizes:**
- `Explosion02HD_5x5.tga`: 17MB
- 5√ó laser sound files: 68-93KB each
- Old Godot textures: 2-3MB each (removed)

**Setup:**
```bash
git lfs install
git lfs track "*.tga"
git lfs track "*.wav"
git add .gitattributes
```

**Verification:**
```bash
git lfs ls-files
# Shows:
# d94ffd1d8d * assets/audio/sfx/laser0.wav
# cdbe652abf * assets/audio/sfx/laser1.wav
# ... (all 6 files tracked)
```

**Repository Organization:**
- `docs/` - Version-controlled technical documentation
- `devlogs/` - Added to `.gitignore` (AI agent context, ephemeral)
- `*.log` - Added to `.gitignore`

---

## Testing Results

### Before Fixes
- ‚ùå Segfault on startup
- ‚ùå Full sprite sheet visible (no animation)
- ‚ùå Random B0003 panics during tower destruction
- ‚ùå Missing documentation for new features

### After Fixes
- ‚úÖ Game runs with AMD GPU workaround command
- ‚úÖ Explosions animate smoothly (25 frames @ ~12.5 FPS)
- ‚úÖ No crashes during tower destruction cascade (2000+ units)
- ‚úÖ Frame updates logged: `"üéûÔ∏è Explosion frame update: 0 ‚Üí 1 ‚Üí 2 ‚Üí 3 ‚Üí 4"`
- ‚úÖ Tower destruction properly spawns single large explosion
- ‚úÖ Unit explosions stagger over 0.5-3.0 seconds
- ‚úÖ Explosions fade out in final 10% of duration
- ‚úÖ Comprehensive documentation for future development

---

## Code Statistics

**Files Modified:**
- `src/explosion_shader.rs` - API compatibility, debug logging
- `src/objective.rs` - Custom shader usage, try_insert() fixes
- `README.md` - Git LFS, AMD GPU, features update
- `docs/EXPLOSION_SYSTEM.md` - Troubleshooting updates

**Lines Changed (This Session):**
- ~150 lines modified
- ~1,200 lines documentation added

---

## Commit History

1. `fix: update ExplosionMaterial for Bevy 0.14.2 compatibility`
   - MeshVertexBufferLayoutRef type fix

2. `fix: resolve explosion animation and entity despawn crashes`
   - Switch to custom shader for proper animation
   - Replace insert() with try_insert() for race condition

3. `docs: add comprehensive project and explosion system documentation`
   - PROJECT_OVERVIEW.md
   - EXPLOSION_SYSTEM.md

4. `chore: configure Git LFS for textures and audio`
   - Track *.tga and *.wav files

5. `feat: add explosion sprite sheet, audio, and shader assets`
   - 17MB texture (Git LFS)
   - 5 audio files (Git LFS)
   - Custom WGSL shader

6. `docs: move technical documentation to docs/ directory`
   - Reorganize from devlogs/ to docs/
   - Add devlogs/ to .gitignore

7. `docs: update README with Git LFS requirements and new features`
   - Installation instructions
   - Updated controls
   - Documentation links

---

## Lessons Learned

### 1. Bevy Material System Limitations
**StandardMaterial** is designed for static textures. For animated sprite sheets, custom materials with shaders are required. The animation system must update uniforms that the shader uses to calculate UV coordinates.

### 2. Command Buffer Timing
When working with entity commands in Bevy:
- Commands are **deferred** - not applied immediately
- `commands.get_entity()` checks existence at **command creation time**
- `insert()` fails at **command flush time** if entity is gone
- Use `try_insert()` for scenarios where entities may be despawned between creation and flush

### 3. Race Conditions in Concurrent Systems
With 10,000 entities and multiple systems running in parallel:
- Entity queries capture a **snapshot** of the world
- Entities can be modified/despawned by other systems before commands flush
- Always design for graceful degradation when entities may not exist

### 4. GPU Driver Workarounds
AMD drivers on Linux with Vulkan can have stability issues. Document platform-specific workarounds clearly in README for user experience.

### 5. Documentation for Long-Term Maintenance
Comprehensive documentation written **during** development (while context is fresh) saves enormous time for future work. Include:
- Why decisions were made
- What alternatives were tried
- Known limitations and workarounds
- Troubleshooting for common issues

---

## Next Steps (Future Work)

Based on draft note found in chat:
> "Thanks, this works as a baseline of explosion effects. I'd like to explore more on how to improve this in the following order:
> 1. particle"

### Suggested Enhancements

1. **GPU Particle System**
   - Compute shader for particle updates
   - Debris, sparks, embers
   - Smoke trails
   - Integration with sprite sheet base

2. **Enhanced Audio**
   - Explosion sound effects
   - 3D spatial audio
   - Synchronized with visual

3. **Post-Processing Effects**
   - Camera shake
   - Heat wave distortion
   - Chromatic aberration
   - Bloom enhancement

4. **Physics Integration**
   - Ragdoll units on death
   - Debris with physics
   - Explosion force impulses

---

## Environment Details

- **Bevy:** 0.14.2 (upgraded from 0.14.0/0.14.1)
- **Rust:** 1.90.0
- **Platform:** Linux (Ubuntu 22.04)
- **GPU:** AMD Radeon RX 7900 XTX (RADV GFX1100)
- **Driver:** Mesa 23.2.1, radv (LLPC)
- **Backend:** Vulkan (with workaround required)

---

**End of Session Log**

