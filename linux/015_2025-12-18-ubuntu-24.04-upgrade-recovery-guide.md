# Ubuntu 24.04 Upgrade Recovery Guide

**Date:** 2025-12-18
**Purpose:** Recovery steps if things break after upgrading from Ubuntu 22.04 to 24.04
**Hardware:** AMD Ryzen CPU + AMD RX 7900 XTX GPU

## Pre-Upgrade State (for reference)

```bash
# Kernel
6.8.0-90-generic

# ROCm
6.4.3

# GRUB params
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash acpi_enforce_resources=lax iommu=pt amdgpu.gfxoff=0 amdgpu.tmz=0 amdgpu.runpm=0"
```

---

## Issue 1: Black Screen / No Display After Reboot

### Try TTY
Press `Ctrl+Alt+F3` to get a text console.

### Boot with nomodeset (temporary)
1. At GRUB menu, press `e` to edit
2. Find line starting with `linux`
3. Add `nomodeset` at the end
4. Press `F10` to boot

### Reinstall amdgpu driver
```bash
sudo apt update
sudo apt install --reinstall linux-firmware
sudo apt install --reinstall xserver-xorg-video-amdgpu
sudo reboot
```

---

## Issue 2: ROCm / PyTorch Not Working

### Check if ROCm is detected
```bash
rocminfo
rocm-smi
```

### Reinstall ROCm 6.4.x
```bash
# Remove old installation
sudo apt purge rocm-* hip-* 2>/dev/null
sudo apt autoremove

# Add ROCm repo (if missing)
wget https://repo.radeon.com/amdgpu-install/6.4.3/ubuntu/noble/amdgpu-install_6.4.60403-1_all.deb
sudo dpkg -i amdgpu-install_6.4.60403-1_all.deb

# Install ROCm
sudo amdgpu-install --usecase=rocm

sudo reboot
```

### Verify PyTorch sees GPU
```bash
python3 -c "import torch; print(torch.cuda.is_available()); print(torch.cuda.get_device_name(0))"
```

### If PyTorch still fails
```bash
# Reinstall PyTorch for ROCm
pip uninstall torch torchvision torchaudio
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm6.2
```

---

## Issue 3: GRUB Parameters Lost

### Check current params
```bash
cat /proc/cmdline
```

### Restore params
```bash
sudo nano /etc/default/grub
```

Set:
```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash acpi_enforce_resources=lax iommu=pt amdgpu.gfxoff=0 amdgpu.tmz=0 amdgpu.runpm=0"
```

Apply:
```bash
sudo update-grub
sudo reboot
```

---

## Issue 4: GUI Won't Start / GNOME Crashes

### Check Xorg/Wayland logs
```bash
journalctl -b -0 | grep -i "gnome\|gdm\|mutter" | tail -50
cat ~/.local/share/xorg/Xorg.0.log | tail -100
```

### Try X11 instead of Wayland
Edit `/etc/gdm3/custom.conf`:
```bash
sudo nano /etc/gdm3/custom.conf
```

Uncomment:
```
WaylandEnable=false
```

```bash
sudo systemctl restart gdm3
```

### Reset GNOME settings (nuclear option)
```bash
dconf reset -f /org/gnome/
```

---

## Issue 5: Kernel Panic / Won't Boot

### Boot previous kernel
1. Hold `Shift` during boot to show GRUB menu
2. Select "Advanced options for Ubuntu"
3. Choose older kernel (6.8.0-xx-generic)

### If older kernel works
```bash
# Check installed kernels
dpkg --list | grep linux-image

# Set default kernel in GRUB
sudo nano /etc/default/grub
# Change GRUB_DEFAULT=0 to specific kernel entry
```

---

## Issue 6: amdgpu Module Not Loading

### Check if module exists
```bash
modinfo amdgpu
```

### Force rebuild DKMS modules
```bash
sudo dkms autoinstall
sudo update-initramfs -u
sudo reboot
```

### Check dmesg for errors
```bash
sudo dmesg | grep -i amdgpu | head -50
```

---

## Issue 7: Sound Not Working

```bash
# Reinstall PulseAudio/PipeWire
sudo apt install --reinstall pipewire pipewire-pulse wireplumber

# Restart audio
systemctl --user restart pipewire pipewire-pulse wireplumber
```

---

## Issue 8: Network Not Working

```bash
# Check interfaces
ip link

# Restart NetworkManager
sudo systemctl restart NetworkManager

# If WiFi missing
sudo apt install --reinstall linux-firmware
sudo modprobe -r iwlwifi && sudo modprobe iwlwifi  # Intel WiFi
```

---

## Rollback Option (if all else fails)

If you have Timeshift snapshots:
```bash
sudo timeshift --restore
```

Otherwise, fresh install preserving /home:
1. Boot Ubuntu 24.04 USB
2. Choose "Something else" during installation
3. Mount existing /home partition without formatting
4. Format only / partition

---

## Verification Checklist After Upgrade

```bash
# OS version
lsb_release -a

# Kernel
uname -r

# GPU detected
lspci | grep -i vga

# amdgpu loaded
lsmod | grep amdgpu

# ROCm working
rocm-smi

# GRUB params active
cat /proc/cmdline

# PyTorch GPU
python3 -c "import torch; print(torch.cuda.is_available())"
```
