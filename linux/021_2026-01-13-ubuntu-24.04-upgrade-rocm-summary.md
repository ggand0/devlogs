# Ubuntu 24.04 Upgrade + ROCm Issues Summary

**Date:** 2026-01-13
**Context:** Summary of devlogs 015-019 documenting the Ubuntu 22.04 → 24.04 upgrade issues
**Related:** [015](015_2025-12-18-ubuntu-24.04-upgrade-recovery-guide.md), [016](016_2025-01-04-ubuntu-24.04-upgrade-rocm-reinstall.md), [017](017_2025-01-04-ubuntu-24.04-upgrade-log.md), [018](018_2025-01-05-ubuntu-24.04-post-upgrade-fixes.md), [019](019_2025-01-05-ubuntu-24.04-post-upgrade-config.md)

## The Core Problem

The old ROCm 6.4.3 installation from Ubuntu 22.04 left behind incompatible libraries and configs that broke GNOME/display after upgrading to 24.04.

---

## Issues Encountered

### 1. PostgreSQL blocking upgrade

Upgrade failed because `postgresql-12` and `postgresql-15` were in the removal deny list.

**Fix:**
```bash
sudo apt purge postgresql*
```

### 2. ROCm repo disabled during upgrade

Third-party repos (including ROCm) are automatically disabled by `do-release-upgrade`. Required re-adding the ROCm repo for `noble` and reinstalling `amdgpu-dkms` + `rocm`.

### 3. GNOME crash screen ("Oh no! Something has gone wrong")

Caused by multiple leftover ROCm artifacts:

| Issue | Cause | Fix |
|-------|-------|-----|
| Invalid udev rule | 24.04 stricter parsing: `KERNEL=` vs `KERNEL==` | Fixed syntax in `/etc/udev/rules.d/70-amdgpu.rules` |
| Missing `drmModeCloseFB` symbol | ROCm's old libdrm in `/opt/amdgpu/lib/` loaded instead of system libdrm | Backed up `/etc/ld.so.conf.d/{15-amdgpu-pro,20-amdgpu}.conf` |
| Xorg segfault in radeonsi_dri.so | Old `/etc/X11/xorg.conf` from amdgpu-pro + more ROCm ld.so.conf files | Removed xorg.conf, backed up `10-rocm-opencl.conf` and `rocm.conf` |

### 4. Config files to preserve during upgrade

- `/etc/default/grub` — kept AMD GPU stability params (`amdgpu.gfxoff=0`, `amdgpu.tmz=0`, `amdgpu.runpm=0`)
- `/etc/security/limits.conf` — custom resource limits for GPU workloads

---

## Key Fixes Summary

```bash
# Backed up problematic ld.so.conf files
sudo mv /etc/ld.so.conf.d/15-amdgpu-pro.conf{,.bak}
sudo mv /etc/ld.so.conf.d/20-amdgpu.conf{,.bak}
sudo mv /etc/ld.so.conf.d/10-rocm-opencl.conf{,.bak}
sudo mv /etc/ld.so.conf.d/rocm.conf{,.bak}
sudo mv /etc/X11/xorg.conf{,.bak}
sudo ldconfig

# Fixed udev rule syntax
# KERNEL="kfd" → KERNEL=="kfd"

# Reinstalled ROCm for noble
sudo apt install amdgpu-dkms rocm
```

---

## End Result

- GUI working on Wayland (X11 had additional issues fixed in devlog 020)
- ROCm compute stack still functional despite disabling the old ld.so.conf files
- PyTorch GPU detection working
