# Ubuntu 24.04 Post-Upgrade Fixes

**Date:** 2025-01-05
**Issue:** GNOME crash screen ("Oh no! Something has gone wrong") after 24.04 upgrade

## Symptom

After upgrading to Ubuntu 24.04, system boots to white GNOME crash screen with "X_X" icon. TTY access initially unavailable.

## Issue 1: Invalid udev Rule Syntax (FIXED)

**File:** `/etc/udev/rules.d/70-amdgpu.rules`

Ubuntu 24.04 has stricter udev parsing. Operators were swapped.

**Broken:**
```
KERNEL="kfd", GROUP=="video", MODE="660"
```

**Fixed:**
```
KERNEL=="kfd", GROUP="video", MODE="0660"
```

## Issue 2: libdrm Conflict - Missing drmModeCloseFB (FIXED)

**Error:**
```
/usr/bin/gnome-shell: symbol lookup error: /lib/x86_64-linux-gnu/libmutter-14.so.0: undefined symbol: drmModeCloseFB
```

**Root Cause:**
Old ROCm installation had its own libdrm in `/opt/amdgpu/lib/`. The ld.so.conf files were forcing system to load ROCm's older libdrm instead of system libdrm.

```bash
# This showed the problem:
ldd /usr/lib/x86_64-linux-gnu/libmutter-14.so.0 | grep libdrm
# Output: libdrm.so.2 => /opt/amdgpu/lib/x86_64-linux-gnu/libdrm.so.2

# ROCm's libdrm missing the symbol:
nm -D /opt/amdgpu/lib/x86_64-linux-gnu/libdrm.so.2 | grep drmModeCloseFB
# (empty - symbol not present)

# System libdrm has it:
nm -D /usr/lib/x86_64-linux-gnu/libdrm.so.2 | grep drmModeCloseFB
# 000...0e020 T drmModeCloseFB
```

**Fix:**
```bash
cd /etc/ld.so.conf.d/
sudo mv 15-amdgpu-pro.conf 15-amdgpu-pro.conf.bak
sudo mv 20-amdgpu.conf 20-amdgpu.conf.bak
sudo ldconfig
```

**Verification:**
```bash
ldd /usr/lib/x86_64-linux-gnu/libmutter-14.so.0 | grep libdrm
# Should now show: /usr/lib/x86_64-linux-gnu/libdrm.so.2
```

## Issue 3: Xorg Segfault in radeonsi_dri.so (FIXING)

After fixing libdrm, X server crashes with segfault:

```
(EE) 2: /usr/lib/x86_64-linux-gnu/dri/radeonsi_dri.so (__driDriverGetExtensions_virtio_gpu+0x17a6)
(EE) Segmentation fault at address 0x0
Fatal server error: Caught signal 11 (Segmentation fault). Server aborting
```

Also found old xorg.conf being used:
```
(==) Using config file: "/etc/X11/xorg.conf"
```

**Fix:**
```bash
# Remove old xorg.conf (likely from amdgpu-pro)
sudo mv /etc/X11/xorg.conf /etc/X11/xorg.conf.bak

# Reinstall Mesa drivers
sudo apt install --reinstall mesa-vulkan-drivers libgl1-mesa-dri

# Restart display manager
sudo systemctl restart gdm3
```

## Issue 4: Mesa radeonsi_dri.so Segfault (FIXED)

After fixing libdrm, X server still crashed during GLX initialization:
```
/usr/lib/x86_64-linux-gnu/dri/radeonsi_dri.so (__driDriverGetExtensions_virtio_gpu...)
Segmentation fault at address 0x0
```

**Root Cause:** Additional ROCm ld.so.conf files were still loading incompatible libraries.

**Fix:**
```bash
# Disable remaining ROCm ld.so.conf entries
sudo mv /etc/ld.so.conf.d/10-rocm-opencl.conf /etc/ld.so.conf.d/10-rocm-opencl.conf.bak
sudo mv /etc/ld.so.conf.d/rocm.conf /etc/ld.so.conf.d/rocm.conf.bak
sudo ldconfig

# Enable Wayland
sudo nano /etc/gdm3/custom.conf
# Comment out: WaylandEnable=false

sudo systemctl restart gdm3
```

## Files Backed Up

- `/etc/ld.so.conf.d/15-amdgpu-pro.conf` → `.bak`
- `/etc/ld.so.conf.d/20-amdgpu.conf` → `.bak`
- `/etc/ld.so.conf.d/10-rocm-opencl.conf` → `.bak`
- `/etc/ld.so.conf.d/rocm.conf` → `.bak`
- `/etc/X11/xorg.conf` → `.bak`

## Summary

The old ROCm 6.4.3 installation from Ubuntu 22.04 left behind incompatible libraries and configs:

1. **ld.so.conf entries** pointing to `/opt/amdgpu/` caused wrong libdrm to load
2. **xorg.conf** from amdgpu-pro caused X server issues
3. **udev rules** had syntax that 24.04 doesn't accept

After GUI works, need to properly reinstall ROCm for Ubuntu 24.04 (noble).

## Next Steps

1. Verify GUI works after Mesa reinstall
2. Reinstall ROCm for 24.04 (see devlog 016)
3. Re-enable ld.so.conf entries if needed for ROCm after proper reinstall
