# Ubuntu 24.04 Upgrade and ROCm Reinstallation

**Date:** 2025-01-04
**Context:** Upgrading from Ubuntu 22.04 to 24.04 to improve AMD 7900 XTX stability
**Related:** [009_2025-12-18-amd-crash-continued-mitigation.md](009_2025-12-18-amd-crash-continued-mitigation.md), [015_2025-12-18-ubuntu-24.04-upgrade-recovery-guide.md](015_2025-12-18-ubuntu-24.04-upgrade-recovery-guide.md)

## Why Upgrade

Ubuntu 24.04 provides better RDNA3 support:
- Newer kernel (6.8+ base) with native gfx1100 support
- Newer linux-firmware with updated MES firmware
- Newer Mesa graphics stack
- Potentially better Mutter GPU reset handling
- ROCm 6.4.3 officially supports Ubuntu 24.04 (Noble)

## Pre-Upgrade State

```
Ubuntu: 22.04.5 LTS
Kernel: 6.8.0-90-generic (HWE)
ROCm: 6.4.3
Last backup: 2025-12-31 (Deja Dup)
```

## Upgrade Process

### 1. Prerequisites
```bash
sudo apt update && sudo apt upgrade -y
```

### 2. Remove PostgreSQL (blocked upgrade)
```bash
sudo apt purge postgresql-12 postgresql-15
sudo apt autoremove
```

### 3. Run Upgrade
```bash
sudo do-release-upgrade
```

Note: Third-party repos (including ROCm) are automatically disabled during upgrade.

## Post-Upgrade: ROCm Reinstallation

### Why Reinstall is Needed

- ROCm repo was disabled during upgrade
- amdgpu-dkms may not rebuild properly for new kernel
- Package was built for jammy (22.04), not noble (24.04)

### Step 1: Install Kernel Headers

Required for DKMS to compile the kernel module:
```bash
sudo apt install "linux-headers-$(uname -r)" "linux-modules-extra-$(uname -r)"
```

### Step 2: Re-add ROCm Repository for Noble

The GPG key should still exist from before. Just update the repo:
```bash
echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/rocm.gpg] https://repo.radeon.com/rocm/apt/6.4.3 noble main" \
    | sudo tee /etc/apt/sources.list.d/rocm.list
sudo apt update
```

If GPG key is missing:
```bash
sudo mkdir --parents --mode=0755 /etc/apt/keyrings
wget https://repo.radeon.com/rocm/rocm.gpg.key -O - | \
    gpg --dearmor | sudo tee /etc/apt/keyrings/rocm.gpg > /dev/null
```

### Step 3: Install amdgpu-dkms
```bash
sudo apt install amdgpu-dkms
```

### Step 4: Install ROCm
```bash
sudo apt install rocm
```

### Step 5: Reboot and Verify
```bash
sudo reboot

# After reboot
dkms status
rocm-smi
rocminfo
python3 -c "import torch; print(torch.cuda.is_available())"
```

## Existing Config (Should Persist)

These were set during initial ROCm install and should survive the upgrade:

**User groups:**
```bash
# Verify with: groups $USER
# Should include: render, video
```

**Linker config** (`/etc/ld.so.conf.d/rocm.conf`):
```
/opt/rocm/lib
/opt/rocm/lib64
```

**Bashrc exports** (`~/.bashrc`):
```bash
export LD_LIBRARY_PATH=/opt/rocm/lib
export HIP_VISIBLE_DEVICES=0
export HSA_OVERRIDE_GFX_VERSION=11.0.0
```

## Troubleshooting

### If amdgpu-dkms fails to build
```bash
# Check build logs
cat /var/lib/dkms/amdgpu/*/build/make.log

# Ensure headers match running kernel
apt list --installed | grep linux-headers
uname -r
```

### If rocm-smi doesn't detect GPU
```bash
# Check if module loaded
lsmod | grep amdgpu

# Check dmesg for errors
sudo dmesg | grep -i amdgpu | tail -20

# Try manual load
sudo modprobe amdgpu
```

### If PyTorch doesn't see GPU
```bash
# Reinstall PyTorch for ROCm
pip uninstall torch torchvision torchaudio
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm6.2
```

## References

- Blog: [ROCm 6.4.3 Installation](https://ggando.com/blog/rocm1/)
- Blog: [Initial ROCm Setup](https://ggando.com/blog/rocm0/)
- [ROCm 6.4.3 Quick Start](https://rocm.docs.amd.com/projects/install-on-linux/en/docs-6.4.3/install/quick-start.html)
